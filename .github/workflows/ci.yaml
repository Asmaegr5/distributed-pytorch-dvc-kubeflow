name: CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3

    - name: Set up Python 3.9
      uses: actions/setup-python@v4
      with:
        python-version: "3.9"

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Run Preprocessing
      run: |
        python src/preprocess.py

    - name: Run Evaluation (Smoke Test against untreated model or quick train)
      # We just want to check if the script runs.
      # Training for 5 epochs takes time, so let's override params validation for CI if possible
      # or just check if evaluate runs (even with poor model).
      # For a true CI, we might run 1 small epoch.
      run: |
        # Hack params.yaml to 1 epoch, cpu backend
        sed -i 's/epochs: 5/epochs: 1/' params.yaml
        sed -i 's/backend: "nccl"/backend: "gloo"/' params.yaml || true
        python src/train_ddp.py
